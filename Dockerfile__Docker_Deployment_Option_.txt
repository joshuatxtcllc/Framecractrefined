# Build stage

FROM node:18-alpine AS builder

WORKDIR /app

# Copy package files

COPY package*.json ./
COPY client/package*.json ./client/
COPY server/package*.json ./server/ 2>/dev/null || true

# Install dependencies

RUN npm ci –include=dev

# Copy source code

COPY . .

# Build the application

RUN npm run build

# Production stage

FROM node:18-alpine AS production

WORKDIR /app

# Copy package files and install production dependencies

COPY package*.json ./
RUN npm ci –only=production && npm cache clean –force

# Copy built application

COPY –from=builder /app/dist ./dist

# Create non-root user

RUN addgroup -g 1001 -S nodejs
RUN adduser -S framekraft -u 1001

# Change ownership

RUN chown -R framekraft:nodejs /app
USER framekraft

# Expose port

EXPOSE 5000

# Health check

HEALTHCHECK –interval=30s –timeout=10s –start-period=5s –retries=3   
CMD node -e “require(‘http’).request(‘http://localhost:5000/health’, (r) => process.exit(r.statusCode === 200 ? 0 : 1)).end()”

# Start the application

CMD [“npm”, “start”]